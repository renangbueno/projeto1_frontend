<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scanner QR</title>
<style>
  body{font-family:Arial,sans-serif; margin:12px; display:flex; flex-direction:column; gap:12px; align-items:center}
  .card{max-width:640px; width:100%; border:1px solid #ddd; padding:12px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.03)}
  video{width:100%; height:auto; border-radius:8px; background:#000}
  #controls{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
  select,button{padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:white}
  #resultado{margin-top:10px; word-break:break-word}
  #preview{max-width:100%; margin-top:8px; border-radius:8px}
</style>
</head>
<body>
<h2>Leitor QR</h2>
<div class="card">
  <video id="video" playsinline muted></video>
  <div id="controls">
    <select id="cameraSelect"></select>
    <button id="btnStart">Usar c칙mera</button>
    <button id="btnStop" disabled>Parar</button>
    <button id="btnTorch" disabled>游댡 Flash</button>
    <button id="btnUpload">游늬 Enviar imagem</button>
  </div>
  <div id="resultado"><small>Resultado aparecer치 aqui</small></div>
  <img id="preview" alt="" style="display:none"/>
</div>
<input id="fileInput" type="file" accept="image/*" style="display:none"/>

<script type="module">
import QrScanner from 'https://cdn.jsdelivr.net/gh/nimiq/qr-scanner@1.4.2/qr-scanner.min.js';
QrScanner.WORKER_PATH = 'https://cdn.jsdelivr.net/gh/nimiq/qr-scanner@1.4.2/qr-scanner-worker.min.js';

const video = document.getElementById('video');
const cameraSelect = document.getElementById('cameraSelect');
const btnStart = document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const btnTorch = document.getElementById('btnTorch');
const btnUpload = document.getElementById('btnUpload');
const resultado = document.getElementById('resultado');
const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');

let qrScanner = null;
let currentStream = null;
let currentTrack = null;
let torchOn = false;

function escapeHtml(str){return (str+'').replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}

function showResult(text){
  resultado.innerHTML = `<strong>Conte칰do:</strong> ${escapeHtml(text)}`;
  try{
    const url = new URL(text);
    const params = new URLSearchParams(url.search);
    if([...params].length){
      let html='<ul>';
      for(const [k,v] of params.entries()){
        html+=`<li><strong>${escapeHtml(k)}</strong>: ${escapeHtml(v)}</li>`;
      }
      html+='</ul>';
      resultado.innerHTML += html;
    }
  }catch(e){}
}

async function listCameras(){
  try{
    const devices = await QrScanner.listCameras(true);
    cameraSelect.innerHTML='';
    devices.forEach(d=>{
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = d.label || `C칙mera (${d.id})`;
      cameraSelect.appendChild(opt);
    });
    if(devices.length===0){
      cameraSelect.innerHTML='<option>Nenhuma c칙mera detectada</option>';
    }
  }catch(e){
    console.error(e);
    cameraSelect.innerHTML='<option>Erro ao listar c칙meras</option>';
  }
}

async function startScanner(){
  if(qrScanner) await stopScanner();
  const preferredDeviceId = cameraSelect.value || null;
  qrScanner = new QrScanner(video, result=>{
    showResult(result);
    // opcional: parar ap칩s leitura
    // qrScanner.stop();
  },{
    preferredCamera: preferredDeviceId||'environment',
    highlightScanRegion:true,
    maxScansPerSecond:10
  });
  try{
    await qrScanner.start();
    btnStart.disabled=true;
    btnStop.disabled=false;
    currentStream = qrScanner.$video.srcObject;
    currentTrack = currentStream && currentStream.getVideoTracks && currentStream.getVideoTracks()[0];
    await checkTorchSupport();
  }catch(e){
    console.error('Erro ao iniciar scanner:',e);
    resultado.innerHTML=`<small>Erro ao acessar c칙mera: ${escapeHtml(String(e))}. Use envio de imagem como fallback.</small>`;
  }
}

async function stopScanner(){
  if(qrScanner){try{await qrScanner.stop()}catch{} qrScanner.destroy(); qrScanner=null;}
  if(currentStream){currentStream.getTracks().forEach(t=>t.stop()); currentStream=null;}
  currentTrack=null;
  btnStart.disabled=false; btnStop.disabled=true; btnTorch.disabled=true; torchOn=false;
}

async function checkTorchSupport(){
  btnTorch.disabled=true;
  if(!currentTrack) return;
  const caps=currentTrack.getCapabilities?currentTrack.getCapabilities():{};
  if(caps.torch){btnTorch.disabled=false;}
}

async function toggleTorch(){
  if(!currentTrack) return;
  const caps=currentTrack.getCapabilities?currentTrack.getCapabilities():{};
  if(!caps.torch){resultado.innerHTML='<small>Flash n칚o suportado neste dispositivo/browser.</small>'; return;}
  try{
    torchOn=!torchOn;
    await currentTrack.applyConstraints({advanced:[{torch:torchOn}]});
    btnTorch.textContent = torchOn ? '游댡 Flash On' : '游댡 Flash';
  }catch(e){resultado.innerHTML=`<small>Erro ao alternar flash: ${escapeHtml(String(e))}</small>`;}
}

btnStart.addEventListener('click',()=>startScanner());
btnStop.addEventListener('click',()=>stopScanner());
btnTorch.addEventListener('click',toggleTorch);

// upload fallback
btnUpload.addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',async ev=>{
  const file = ev.target.files && ev.target.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  preview.src=url; preview.style.display='block';
  try{
    const text = await QrScanner.scanImage(file,{returnDetailedScanResult:false});
    showResult(text);
  }catch(e){
    resultado.innerHTML=`<small>N칚o foi poss칤vel ler o QR da imagem: ${escapeHtml(String(e))}</small>`;
  }finally{URL.revokeObjectURL(url);}
});

// trocar c칙mera
cameraSelect.addEventListener('change',async()=>{if(qrScanner) await startScanner();});

// inicializa lista de c칙meras
(async()=>{await listCameras();})();
window.addEventListener('pagehide',stopScanner);
</script>
</body>
</html>
